<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    metal:use-macro="here/main_template/macros/master"
    i18n:domain="bika">

<head>
    <metal:block fill-slot="javascript_head_slot"
            tal:define="portal context/@@plone_portal_state/portal;">
        <script type="text/javascript"
                tal:attributes="src python:portal.absolute_url() + '/bika_widgets/datetimewidget.js'"></script>
        <script type="text/javascript"
                tal:attributes="src python:portal.absolute_url() + '/bika_widgets/referencewidget.js'"></script>
        <link rel="stylesheet" type="text/css" media="all" href=""
                tal:attributes="href string:${portal/absolute_url}/bika_widgets/referencewidget.css" />
    </metal:block>
</head>

<body>

<metal:title fill-slot="content-title">
    <h1>
        <img tal:condition="view/icon | nothing" tal:attributes="src view/icon"/>
        <tal:new i18n:translate="">Request new analyses</tal:new>
    </h1>
</metal:title>

<div metal:fill-slot="content-core"
        tal:define="
        portal context/@@plone_portal_state/portal;
        plone_view context/@@plone;
        portal_state context/@@plone_portal_state;
        currencies python:modules['zope.i18n.locales'].locales.getLocale('en').numbers.currencies;
        currency python:context.bika_setup.getCurrency();
        checkPermission nocall: context/portal_membership/checkPermission;
        tabindex view/tabindex;
        partitionable view/partitioned_services;
        ShowPrices python:context.bika_setup.getShowPrices();">


<form id="analysisrequest_edit_form"
    name="analysisrequest_edit_form"
    method="POST">

    <input type="hidden" name="submitted" value="1" />
    <span tal:replace="structure context/@@authenticator/authenticator"/>
    <input type="hidden" name="came_from" tal:attributes="value view/came_from" />

    <span id="bika_setup" style="display:none;"
            tal:define="bika_setup python: context.bika_setup;"
            tal:attributes="EnableARSpecs python: 'true' if bika_setup.getEnableARSpecs() else '';
                    bika_samplepoints_uid python: bika_setup.bika_samplepoints.UID();
                    bika_artemplates_uid python: bika_setup.bika_artemplates.UID();
                    bika_analysisprofiles_uid python: bika_setup.bika_analysisprofiles.UID();
                    bika_analysisspecs_uid python: bika_setup.bika_analysisspecs.UID();
                    bika_analysisspecs_path python:'/'.join(bika_setup.bika_analysisspecs.getPhysicalPath())">
    </span>

    <!-- member discount percentage if applicable -->
    <input type="hidden" id="member_discount" name="member_discount"
            tal:attributes="value here/bika_setup/getMemberDiscount"
            tal:condition="view/getMemberDiscountApplies"/>

    <!-- col_count goes here for the jquery expanding services rows to know how to print themselves -->
    <input type="hidden" id="col_count" name="col_count"
            tal:attributes="value view/col_count" />

    <!-- These services have partition setup records -->
    <input type="hidden" id="partitioned_services" name="partitioned_services"
            tal:attributes="value partitionable" />

    <!-- And the current form partition configuration is stored here -->
    <input type="hidden" id="parts" name="parts" value="{}"/>

    <!-- The specs for each AR. -->
    <input type="hidden" id="specs" name="specs" value="{}"
            tal:attributes="value python:modules['json'].dumps(dict([(x, {}) for x in range(view.col_count)]))"/>

    <!-- The specs for each AR - this value is completed when using copy_to_new in this form.
     The value in this field is blended with the 'Specification' found in the form. -->
    <input type="hidden" id="copy_to_new_specs" name="copy_to_new_specs" value="{}"
            tal:attributes="value view/copy_to_new_specs"/>

    <!-- The system configured 'Dry Matter Service' -->
    <tal:i define="dms python:context.bika_setup.getDryMatterService()">
        <input type="hidden" id="getDryMatterService" name="getDryMatterService"
                tal:condition="nocall:dms"
                tal:attributes="
                        poc python: dms.getPointOfCapture();
                        cat python: dms.getCategoryUID();
                        value python: dms.UID()"/>
    </tal:i>

    <input type="hidden"
           id="PhysicalPath"
            tal:attributes="here python:'/'.join(context.getPhysicalPath()[:-3])"/>
    <!-- Contact person -->

    <div id="archetypes-fieldname-Contact" class="field ArchetypesReferenceWidget" data-fieldname="Contact">
        <label class="formQuestion" for="Patient" i18n:translate="">Contact
            <span class="required" title="Required"> </span>
        </label>
        <span></span>
        <div class="fieldErrorBox"></div>
        <input id="ar_0_Contact"
               class="blurrable firstToFocus referencewidget ui-autocomplete-input input-bg has_combogrid_widget"
               type="text"
               placeholder=""
               showon="True"
               searchicon="True"
               maxlength="255"
               resetbutton="False"
                tal:attributes="combogrid_options python:view.get_json_format({'colModel': [{'columnName': 'UID', 'hidden': True}, {'columnName': 'Fullname', 'label': 'Name', 'width': '50'}, {'columnName': 'EmailAddress', 'label': 'Email Address', 'width': '50'}], 'minLength': '0', 'search_fields': ['Title'], 'sord': 'asc', 'discard_empty': [], 'searchIcon': True, 'sidx': 'Title', 'url': 'referencewidget_search', 'resetButton': False, 'width': '400px', 'showOn': True, 'force_all': True});
                        base_query python:view.get_json_format({'portal_type':['Contact'],'inactive_state':'active', 'getParentUID':''})"
               catalog_name="portal_catalog"
               search_query="{}"
               ui_item="Title"
               minlength="0"
               name="ar.0.Contact:record"
               autocomplete="off"
               role="textbox"
               aria-autocomplete="list"
               aria-haspopup="true"
               tabindex="10" />


        <input id="ar_0_Contact_uid" type="hidden" name="ar.0.Contact_uid:record">
    </div>

    <!-- Patient template -->
    <span tal:replace="structure view/patient_template"></span>
    <!-- Doctor template -->
    <span tal:replace="structure view/doctor_referrer_template"></span>
    <!-- Insurance template -->
    <span tal:replace="structure view/insurance_template"></span>
    <!-- Analyses template -->
    <span tal:replace="structure view/analyses_template"></span>


    <!-- Submit button -->
    <input class="context button allowMultiSubmit"
           type="submit"
           name="save_button"
            i18n:attributes="value"
           value="Save"/>

    <div class="discreeter">
        <p>  <!-- AVS this should be conditional if any dryables present -->
            <img src="" tal:attributes="src string:${portal/absolute_url}/++resource++bika.lims.images/dry.png">
            <span i18n:translate="">
            Can be <r></r>eported as dry matter</span>
        </p>

        <!-- XXX this also -->
        <p tal:condition="python:context.bika_setup.laboratory.getLaboratoryAccredited()">
            <img tal:attributes="src string:${portal/absolute_url}/++resource++bika.lims.images/accredited.png">
            <span i18n:translate="">
                Methods included in the
                <tal:block
                        replace="here/bika_setup/laboratory/AccreditationBody"
                        i18n:name="accreditation_body"/>
                schedule of Accreditation for this Laboratory.
                Analysis remarks are not accredited
            </span>
        </p>
    </div>

</form>
</div>
</body>
</html>
